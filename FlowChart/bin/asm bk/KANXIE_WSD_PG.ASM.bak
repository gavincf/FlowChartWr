
;KANXIE: follow

;check X 
;gap=16ms 
;*6>100ms

C_KANXIE_VERT_DIF EQU 9;+4
C_KANXIE_HORI_DIF EQU 9;+4

C_KANXIE_HORI_CMP EQU 9;5


C_KANXIE_CNT EQU 4;+1
C_KANXIE_CNT2 EQU 4;+1


;===================================
; ; @FXF15
;===================================

L_KANXIE_OV:
	LDA	R_KANXIE_OV_DLYCNT
	BEQ	L_KANXIE_OV_S20
	INC	R_KANXIE_OV_DLYCNT
	BNE	L_KANXIE_OV_S20

	MR_AVR_X_EN
	MR_AVR_Y_EN
	MR_AVR_Z_EN

;
	STZ	R_KANXIE_CHK_STEP
;
	LDA	R_SWIPE_FLAG
	CMP	#1
	BNE	L_KANXIE_OV_S20

;	JSR	L_CHK_PLAY_HITTYPE

L_KANXIE_OV_S20:
	RTS

;============================
;WAITKEY_GAP2B_PCC
;============================
CHK_KANXIE:
;

	LDA	R_1ST_AVR_CNT
	CMP	#16
	BCC	CHK_KANXIE_EXIT_J1

	LDA	R_KANXIE_STEP_DLYCNT
	BEQ	CHK_KANXIE_S010
	INC	R_KANXIE_STEP_DLYCNT
	BEQ	CHK_KANXIE_S010

;COUNTTING for next step	
CHK_KANXIE_EXIT_J1:
	
	RTS
	
CHK_KANXIE_S010:
;---------------------------------------
;	2 axis: < limit
;---------------------------------------
;
	LDX	R_Gsensor_SaveP
	BNE	CHK_KANXIE_S011
	LDX	#32
CHK_KANXIE_S011:
	DEX

	LDA	R_SaveX_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_HORIZONTAL_VAL_P;;X
	LDA	R_SaveY_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_VERTICAL_VAL_P;;Y
	LDA	R_SaveZ_Base,X

	STA	R_ZVAL;;Z

	LDA	R_KANXIE_CHK_STEP
	ASL	A
	TAX
	JMP	(CHK_KANXIE_TBL,X)
CHK_KANXIE_TBL:
	DW	CHK_KANXIE_0;standby: check start
	DW	CHK_KANXIE_1;
	DW	CHK_KANXIE_2
	DW	CHK_KANXIE_3
	DW	CHK_KANXIE_EXIT;

CHK_KANXIE_0:;default = 0;;OTHER MODE;
	LDA	R_VERTICAL_VAL_P ;Y
	CMP	R_VERTICAL_AVR_P
	BCC	CHK_KANXIE_0_VERT_S10
	SBC	R_VERTICAL_AVR_P
	CMP	#C_KANXIE_VERT_DIF
	BCC	CHK_KANXIE_0_RECOUNT
;-----------------------------------
	BRA	CHK_KANXIE_0_HORT
CHK_KANXIE_0_VERT_S10:
	SEC
	LDA	R_VERTICAL_AVR_P
	SBC	R_VERTICAL_VAL_P
	CMP	#C_KANXIE_VERT_DIF
	BCC	CHK_KANXIE_0_RECOUNT
;
CHK_KANXIE_0_HORT:
	LDA	R_HORIZONTAL_AVR_P ;>10
	CMP	R_HORIZONTAL_VAL_P
	BCC	CHK_KANXIE_0_RECOUNT
	SBC	R_HORIZONTAL_VAL_P
	CMP	#C_KANXIE_HORI_DIF
	BCC	CHK_KANXIE_0_RECOUNT
;start
	LDA	R_HORIZONTAL_VAL_P;X
	STA	R_LAST_HORIZONTAL ;STORE old X AVR
;
;next step
	
	MR_SET_KANXIE_IDX 0,1;
	MR_SET_KANXIE_OV
	MR_AVR_X_DIS
	MR_AVR_Y_DIS
	MR_AVR_Z_EN

	JMP	CHK_KANXIE_EXIT

CHK_KANXIE_0_RECOUNT:
	STZ	R_KANXIE_CNT

CHK_KANXIE_EXIT_J4:
	JMP	CHK_KANXIE_EXIT

CHK_KANXIE_1:
;
	LDA	R_VERTICAL_VAL_P ;>45
	CMP	R_VERTICAL_AVR_P
	BCC	CHK_KANXIE_1_VERT_S10
	SBC	R_VERTICAL_AVR_P
	CMP	#C_KANXIE_VERT_DIF+25;30
	BCC	CHK_KANXIE_1_RECOUNT
;
	BRA	CHK_KANXIE_1_HORT
CHK_KANXIE_1_VERT_S10:
	SEC
	LDA	R_VERTICAL_AVR_P
	SBC	R_VERTICAL_VAL_P
	CMP	#C_KANXIE_VERT_DIF+25;30
	BCC	CHK_KANXIE_1_RECOUNT

CHK_KANXIE_1_HORT:
	LDA	R_LAST_HORIZONTAL ;>10
	CMP	R_HORIZONTAL_VAL_P
	BCC	CHK_KANXIE_1_RECOUNT
	SBC	R_HORIZONTAL_VAL_P
	CMP	#C_KANXIE_HORI_CMP ;--5
	BCC	CHK_KANXIE_1_RECOUNT
;
	LDA	R_LAST_HORIZONTAL
	CMP	#C_SHIFT_PLUS-40
	BCC	CHK_KANXIE_1_S010
	
	LDA	R_HORIZONTAL_VAL_P
	STA	R_LAST_HORIZONTAL ;STORE
;
CHK_KANXIE_1_S010:
	
	MR_SET_KANXIE_IDX 0,2;
	MR_SET_KANXIE_OV
	STZ	R_KANXIE_CNT
;
;	JSR	L_PLAY_HITTYPE

	M_SET_KEYCH0_FLAG
	LDA	#1
	STA	WB_KEYCH_CODE
	LDA	#1
	STA	R_SWIPE_FLAG

	JMP	CHK_KANXIE_EXIT
CHK_KANXIE_1_RECOUNT:
	STZ	R_KANXIE_CNT
;
	
	JMP	CHK_KANXIE_EXIT
	
CHK_KANXIE_2:
;
	LDA	R_LAST_HORIZONTAL ;>10
	CMP	R_HORIZONTAL_VAL_P
	BCC	CHK_KANXIE_2_RECOUNT
	SBC	R_HORIZONTAL_VAL_P
	CMP	#C_KANXIE_HORI_CMP ;5
	BCC	CHK_KANXIE_2_RECOUNT
;
	LDA	R_LAST_HORIZONTAL
	CMP	#C_SHIFT_PLUS-40
	BCC	CHK_KANXIE_2_S010
	
	LDA	R_HORIZONTAL_VAL_P
	STA	R_LAST_HORIZONTAL ;STORE
;
CHK_KANXIE_2_S010:
	INC	R_KANXIE_CNT
	LDA	R_KANXIE_CNT
	CMP	#2
	BCC	CHK_KANXIE_2_J6
;
	MR_SET_KANXIE_IDX 256-2,3; ;48MS*2
	MR_SET_KANXIE_OV
	STZ	R_KANXIE_CNT
;

	JMP	CHK_KANXIE_EXIT
CHK_KANXIE_2_RECOUNT:
	STZ	R_KANXIE_CNT
;
	
CHK_KANXIE_2_J6:
	JMP	CHK_KANXIE_EXIT
	
CHK_KANXIE_3: ;FOR release
;
	LDA	R_VERTICAL_AVR_P
	CMP	R_VERTICAL_VAL_P ;>45
	BCC	CHK_KANXIE_3_VERT_S10
	SBC	R_VERTICAL_VAL_P
	CMP	#30
	BCC	CHK_KANXIE_3_RECOUNT
;
	BRA	CHK_KANXIE_3_S100
CHK_KANXIE_3_VERT_S10:
	SEC
	LDA	R_VERTICAL_VAL_P
	SBC	R_VERTICAL_AVR_P
	CMP	#30
	BCC	CHK_KANXIE_3_RECOUNT
	
CHK_KANXIE_3_S100:

	INC	R_KANXIE_CNT
	LDA	R_KANXIE_CNT
	CMP	#2
	BCC	CHK_KANXIE_EXIT_J5
;
;check Z

;	MR_SET_KANXIE_IDX 256-6,0; ;DELAY @48MS
	MR_SET_KANXIE_IDX 256-6,0; ;DELAY @48MS

	MR_STOP_KANXIE_DLYCNT
	MR_AVR_X_EN
	MR_AVR_Y_EN
	MR_AVR_Z_EN
	STZ	R_SWIPE_FLAG

;	JSR	L_PLAY_HITTYPE

CHK_KANXIE_EXIT_J5:
	JMP	CHK_KANXIE_EXIT
CHK_KANXIE_3_RECOUNT: ;EXIT
	STZ	R_KANXIE_CNT
	
	JMP	CHK_KANXIE_EXIT
	
CHK_KANXIE_EXIT:

	RTS
