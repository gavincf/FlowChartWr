
.IF ( C_SWPWM_PATT_EN .EQ. 1 )

;=====================================
L_PWMS_STOP_W_CHK:
	
	MR_DET_SWPWM_PATT_EN
	BEQ	L_PWMS_STOP_W_CHK_END

	MR_SET_SWPWM_PATT_DIS
;	MR_CHK_PATT_DIS ;------------------------ not clear this flag
	
 .IF ( C_PWMS_MAX .GT. 0 )
	M_PWM0_DIS
	M_PWM0_OFF
	.ENDIF;( C_PWMS_MAX .GT. 0 )
 .IF ( C_PWMS_MAX .GT. 1 )
	PWM1_DISABLE
	M_PWM1_OFF
 .ENDIF;( C_PWMS_MAX .GT. 1 )
 .IF ( C_PWMS_MAX .GT. 2 )
	PWM2_DISABLE
	M_PWM2_OFF
 .ENDIF;( C_PWMS_MAX .GT. 2 )
 .IF ( C_PWMS_MAX .GT. 3 )
	PWM3_DISABLE
	M_PWM3_OFF
 .ENDIF;( C_PWMS_MAX .GT. 3 )
 .IF ( C_PWMS_MAX .GT. 4 )
	PWM4_DISABLE
	M_PWM4_OFF
 .ENDIF;( C_PWMS_MAX .GT. 4 )
 .IF ( C_PWMS_MAX .GT. 5 )
	PWM5_DISABLE
	M_PWM5_OFF
 .ENDIF;( C_PWMS_MAX .GT. 5 )
 .IF ( C_PWMS_MAX .GT. 6 )
	PWM6_DISABLE
	M_PWM6_OFF
 .ENDIF;( C_PWMS_MAX .GT. 6 )
 .IF ( C_PWMS_MAX .GT. 7 )
	PWM7_DISABLE
	M_PWM7_OFF
 .ENDIF;( C_PWMS_MAX .GT. 7 )
L_PWMS_STOP_W_CHK_END:
	RTS

;=====================================
;  BK0_SWPWM_PATT_ST
;=====================================
;IN: x
BK0_SWPWM_PATT_CON:

	MR_DET_SWPWM_PATT_EN
	BEQ	BK0_SWPWM_PATT_ST1
	
	CPX	R_SWPWM_PATT
	BNE	BK0_SWPWM_PATT_ST1
	
;continue
	RTS
;IN: X
BK0_SWPWM_PATT_ST:;
	STX	R_SWPWM_PATT
;
BK0_SWPWM_PATT_ST1:;
	MR_SET_SWPWM_PATT_DIS ;dis for forbidden ISR call

	.IF ( C_SWPWM_DIV_CTRL_EN .EQ. 1 )
	LDA	SWPWM_PATT_DIV_TBL,X
	STA	R_SWPWM_DIV_CTRL
	STA	R_SWPWM_DIV_CTRL_BUF
	.ENDIF ;( C_SWPWM_DIV_EN .EQ. 1 )
	.IF ( C_PWMS_MAX .GT. 0 )
	M_PWM0_EN ; as led pattern enable flag
	M_PWM0_OFF
	.ENDIF;( C_PWMS_MAX .GT. 0 )
	.IF ( C_PWMS_MAX .GT. 1 )
	PWM1_ENABLE
	M_PWM1_OFF
	.ENDIF;( C_PWMS_MAX .GT. 1 )
	.IF ( C_PWMS_MAX .GT. 2 )
	PWM2_ENABLE
	M_PWM2_OFF
	.ENDIF;( C_PWMS_MAX .GT. 2 )
	.IF ( C_PWMS_MAX .GT. 3 )
	PWM3_ENABLE
	M_PWM3_OFF
	.ENDIF;( C_PWMS_MAX .GT. 3 )
	.IF ( C_PWMS_MAX .GT. 4 )
	PWM4_ENABLE
	M_PWM4_OFF
	.ENDIF;( C_PWMS_MAX .GT. 4 )
	.IF ( C_PWMS_MAX .GT. 5 )
	PWM5_ENABLE
	M_PWM5_OFF
	.ENDIF;( C_PWMS_MAX .GT. 5 )
	.IF ( C_PWMS_MAX .GT. 6 )
	PWM6_ENABLE
	M_PWM6_OFF
	.ENDIF;( C_PWMS_MAX .GT. 6 )
	.IF ( C_PWMS_MAX .GT. 7 )
	PWM7_ENABLE
	M_PWM7_OFF
	.ENDIF;( C_PWMS_MAX .GT. 7 )

	STZ	SWPWM_PATT_TBL_PT
	STZ	SWPWM_PATT_TBL_PT+1
	
	MR_CHK_PATT_EN ;default: enable
	
	JSR	LOAD_PWMS_PATT
	MR_SET_SWPWM_PATT_EN
	
	RTS
	
;===============================================
;======================================
; Load new patt table
; LOAD_PWMS_PATT
;=====================================

LOAD_PWMS_PATT_NEXT:
	INC	SWPWM_PATT_TBL_PT
	BNE	LOAD_PWMS_PATT_NEXT_S10
	INC	SWPWM_PATT_TBL_PT+1
LOAD_PWMS_PATT_NEXT_S10:
	
	PLY
	RTS


LOAD_PWMS_PATT: ; in TMG ISR
	PHY

LOAD_PWMS_PATT_RE:
	LDA	R_SWPWM_PATT
	ASL	A
	TAY
	LDA	SWPWM_PATT_TBL,Y
	STA	DP_TMX_ADDR
	INY
	LDA	SWPWM_PATT_TBL,Y
	STA	DP_TMX_ADDR+1
;
	LDA	<SWPWM_PATT_TBL_PT
	STA	<DP_TMX_REG
	LDA	<SWPWM_PATT_TBL_PT+1
	STA	<DP_TMX_REG+1
;
  .IF ( C_SWPWM_PATT_TBL_BYTE .GT. 7)
	CLC
	ROL	<DP_TMX_REG
	ROL	<DP_TMX_REG+1
  .ENDIF;( C_SWPWM_PATT_TBL_BYTE .GT. 7)
  .IF ( C_SWPWM_PATT_TBL_BYTE .GT. 3)
	CLC
	ROL	<DP_TMX_REG
	ROL	<DP_TMX_REG+1
  .ENDIF;( C_SWPWM_PATT_TBL_BYTE .GT. 3)
  .IF ( C_SWPWM_PATT_TBL_BYTE .GT. 1)
	CLC
	ROL	<DP_TMX_REG
	ROL	<DP_TMX_REG+1
  .ENDIF;( C_SWPWM_PATT_TBL_BYTE .GT. 1)
	CLC
	LDA	DP_TMX_ADDR
	ADC	DP_TMX_REG
	STA	DP_TMX_ADDR
	LDA	DP_TMX_ADDR+1
	ADC	DP_TMX_REG+1
	STA	DP_TMX_ADDR+1
;--------------------------

	LDY	#0
	LDA	(<DP_TMX_ADDR),Y
	CMP	#0FDH
	BEQ	LOAD_PWMS_PATT_TIME_J1
	CMP	#0FEH
	BEQ	LOAD_PWMS_PATT_LOOP_J1
	.IF( C_SWPWM_PATT_INCDEC_EN .EQ. 1)
	CMP	#0F9H
	BEQ	LOAD_PWMS_PATT_INC_ST
	CMP	#0FAH
	BEQ	LOAD_PWMS_PATT_INC_TARGET
;	CMP	#0FBH
;	BEQ	LOAD_PWMS_PATT_DEC_ST
	CMP	#0FCH
	BEQ	LOAD_PWMS_PATT_DEC_TARGET
	.ENDIF;( C_SWPWM_PATT_INCDEC_EN .EQ. 1)
	CMP	#0FFH
	BNE	LOAD_PWMS_PATT_DATA_J1
	
LOAD_PWMS_PATT_END:
;-------------------------- pattern end

	JMP	LOAD_PWMS_PATT_END_USER
LOAD_PWMS_PATT_END_USER_RET:
	PLY
	RTS
LOAD_PWMS_PATT_TIME_J1:
	JMP	LOAD_PWMS_PATT_TIME
LOAD_PWMS_PATT_LOOP_J1:
	JMP	LOAD_PWMS_PATT_LOOP
LOAD_PWMS_PATT_DATA_J1:
	JMP	LOAD_PWMS_PATT_DATA
	.IF( C_SWPWM_PATT_INCDEC_EN .EQ. 1)
LOAD_PWMS_PATT_INC_ST:
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_DIV_CTRL
	STA	R_SWPWM_DIV_CTRL_BUF
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	PWM0_LEVEL
	JMP	LOAD_PWMS_PATT_NEXT
LOAD_PWMS_PATT_INC_TARGET:
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_DIV_CTRL
	STA	R_SWPWM_DIV_CTRL_BUF
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_PATT_INCDEC_TARGET
	CMP	PWM0_LEVEL
	BEQ	LOAD_PWMS_PATT_INC_S100
;
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_PATT_ADC
	;
	LDA	PWM0_LEVEL
	CLC
	ADC	R_SWPWM_PATT_ADC
	STA	PWM0_LEVEL
	LDA	PWM0_LEVEL
	CMP	R_SWPWM_PATT_INCDEC_TARGET
	BCS	LOAD_PWMS_PATT_INC_S100
	
	PLY
	RTS
	
LOAD_PWMS_PATT_INC_S100:
	JMP	LOAD_PWMS_PATT_NEXT;NEXT

;LOAD_PWMS_PATT_DEC_ST:
;	INY
;	LDA	(<DP_TMX_ADDR),Y
;	STA	R_SWPWM_DIV_CTRL
;	STA	R_SWPWM_DIV_CTRL_BUF
;	INY
;	LDA	(<DP_TMX_ADDR),Y
;	STA	PWM0_LEVEL
;	JMP	LOAD_PWMS_PATT_NEXT

LOAD_PWMS_PATT_DEC_TARGET:
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_DIV_CTRL
	STA	R_SWPWM_DIV_CTRL_BUF
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_PATT_INCDEC_TARGET
	CMP	PWM0_LEVEL
	BEQ	LOAD_PWMS_PATT_DEC_S100
	DEC	PWM0_LEVEL
	LDA	PWM0_LEVEL
	CMP	R_SWPWM_PATT_INCDEC_TARGET
	BEQ	LOAD_PWMS_PATT_DEC_S100
	
	PLY
	RTS
LOAD_PWMS_PATT_DEC_S100:
	JMP	LOAD_PWMS_PATT_NEXT
	.ENDIF ;( C_SWPWM_PATT_INCDEC_EN .EQ. 1)
	
LOAD_PWMS_PATT_TIME:
	INY
	LDA	SWPWM_PATT_CNT
	BNE	LOAD_PWMS_PATT_TIME_S10
	LDA	(<DP_TMX_ADDR),Y
	STA	SWPWM_PATT_CNT
	BRA	LOAD_PWMS_PATT_LOOP
LOAD_PWMS_PATT_TIME_S10:
	DEC	SWPWM_PATT_CNT
	BNE	LOAD_PWMS_PATT_LOOP
;NEXT
	JMP	LOAD_PWMS_PATT_NEXT
	
LOAD_PWMS_PATT_LOOP:
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	<SWPWM_PATT_TBL_PT+1
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	<SWPWM_PATT_TBL_PT
;
	JMP	LOAD_PWMS_PATT_RE
	
LOAD_PWMS_PATT_DATA:
;-------------------------------------
;
	STA	<PWM0_LEVEL
;
	INY
	LDA	(<DP_TMX_ADDR),Y
	STA	R_SWPWM_DIV_CTRL
	STA	R_SWPWM_DIV_CTRL_BUF

 .IF ( C_PWMS_MAX .GT. 1 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM1_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 1 )
 .IF ( C_PWMS_MAX .GT. 2 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM2_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 2 )
 .IF ( C_PWMS_MAX .GT. 3 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM3_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 3 )
 .IF ( C_PWMS_MAX .GT. 4 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM4_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 4 )
 .IF ( C_PWMS_MAX .GT. 5 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM5_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 5 )
 .IF ( C_PWMS_MAX .GT. 6 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM6_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 6 )
 .IF ( C_PWMS_MAX .GT. 7 )
	INY
	LDA	(<TMGX_ADDR),Y
	STA	<PWM7_LEVEL
 .ENDIF	;( C_PWMS_MAX .GT. 7 )

	JMP	LOAD_PWMS_PATT_NEXT

.ENDIF; ( C_SWPWM_PATT_EN .EQ. 1 )

