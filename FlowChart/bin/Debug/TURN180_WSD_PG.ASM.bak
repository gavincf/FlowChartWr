
;@+/-4g;12bit,
C_TURN180_X EQU 0+C_SHIFT_PLUS
C_TURN180_Y EQU 0+C_SHIFT_PLUS

C_TURN180_Z1 EQU 32+C_SHIFT_PLUS
C_TURN180_Z2 EQU -32+C_SHIFT_PLUS


C_TURN180_TOLERENCE EQU 10


;==================================
;check 
;===================================
;===================================
; ; @FXF15
;===================================
L_TURN180_OV:
	LDA	R_TURN180_OV_DLYCNT
	ORA	R_TURN180_OV_DLYCNT+1
	BEQ	L_TURN180_OV_S20
	INC	R_TURN180_OV_DLYCNT
	BNE	L_TURN180_OV_S20
	INC	R_TURN180_OV_DLYCNT+1
	BNE	L_TURN180_OV_S20
	
	STZ	R_TURN180_CHK_STEP
	
L_TURN180_OV_S20:
	RTS


;===================================
;WAITKEY_GAP2B_PCC
;===================================
CHK_TURN180:
;
	LDA	R_1ST_AVR_CNT
	CMP	#16
	BCC	CHK_TURN180_EXIT_J1

	LDA	R_TURN180_STEP_DLYCNT
	BEQ	CHK_TURN180_S010
	INC	R_TURN180_STEP_DLYCNT
	BEQ	CHK_TURN180_S010

;COUNTTING for next step	
CHK_TURN180_EXIT_J1:
	
	JMP	CHK_TURN180_EXIT
	
CHK_TURN180_S010:
	LDX	R_Gsensor_SaveP
	BNE	CHK_TURN180_S011
	LDX	#32
CHK_TURN180_S011:
	DEX

	LDA	R_SaveX_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_XVAL;;X
	LDA	R_SaveY_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_YVAL;;Y
	LDA	R_SaveZ_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_ZVAL;;Z
;

	LDA	R_TURN180_CHK_STEP
	ASL	A
	TAX
	JMP	(CHK_TURN180_TBL,X)
CHK_TURN180_TBL:
	DW	CHK_TURN180_0;check action start
	DW	CHK_TURN180_1;
	DW	CHK_TURN180_2;

CHK_TURN180_0:;default = 0;;OTHER MODE;
	M_int_Inside_plus R_ZVAL,#(C_TURN180_Z1-C_TURN180_TOLERENCE),#(C_TURN180_Z1+C_TURN180_TOLERENCE)
	BEQ	CHK_TURN180_0_S100
	M_int_Inside_plus R_ZVAL,#(C_TURN180_Z2-C_TURN180_TOLERENCE),#(C_TURN180_Z2+C_TURN180_TOLERENCE)
	BEQ	CHK_TURN180_0_S200

	JMP	CHK_TURN180_0_RELEASE
CHK_TURN180_0_S100:
	M_int_Inside_plus R_XVAL,#(C_TURN180_X-C_TURN180_TOLERENCE),#(C_TURN180_X+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_0_RELEASE
	M_int_Inside_plus R_YVAL,#(C_TURN180_Y-C_TURN180_TOLERENCE),#(C_TURN180_Y+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_0_RELEASE
	
	STZ	R_TURN180_CNT1
	INC	R_TURN180_CNT0
	BNE	CHK_TURN180_0_S110
	DEC	R_TURN180_CNT0
CHK_TURN180_0_S110:
	JMP	CHK_TURN180_EXIT
CHK_TURN180_0_RELEASE:;release
	LDA	R_TURN180_CNT0
	CMP	#4 ; *48MS
	BCS	CHK_TURN180_0_T1
	LDA	R_TURN180_CNT1
	CMP	#4 ; *48MS
	BCS	CHK_TURN180_0_T2

	STZ	R_TURN180_CNT0 ;restart
	STZ	R_TURN180_CNT1 ;restart
	JMP	CHK_TURN180_EXIT

CHK_TURN180_0_T1:
;
	MR_SET_TURN180_IDX 256-3,1;delay 150ms
	MR_SET_TURN180_OV ;500ms
	STZ	R_TURN180_CNT0

	JMP	CHK_TURN180_EXIT
CHK_TURN180_0_T2:
;
	MR_SET_TURN180_IDX 256-3,2;delay 150ms
	MR_SET_TURN180_OV ;500ms
	STZ	R_TURN180_CNT1

	JMP	CHK_TURN180_EXIT

CHK_TURN180_0_S200:
	M_int_Inside_plus R_XVAL,#(C_TURN180_X-C_TURN180_TOLERENCE),#(C_TURN180_X+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_0_RELEASE
	M_int_Inside_plus R_YVAL,#(C_TURN180_Y-C_TURN180_TOLERENCE),#(C_TURN180_Y+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_0_RELEASE

	STZ	R_TURN180_CNT0
	INC	R_TURN180_CNT1
	BNE	CHK_TURN180_0_S210
	DEC	R_TURN180_CNT1
CHK_TURN180_0_S210:
	JMP	CHK_TURN180_EXIT
	
	
CHK_TURN180_1:
	M_int_Inside_plus R_XVAL,#(C_TURN180_X-C_TURN180_TOLERENCE),#(C_TURN180_X+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_1_RECOUNT
	M_int_Inside_plus R_YVAL,#(C_TURN180_Y-C_TURN180_TOLERENCE),#(C_TURN180_Y+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_1_RECOUNT
	M_int_Inside_plus R_ZVAL,#(C_TURN180_Z2-C_TURN180_TOLERENCE),#(C_TURN180_Z2+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_1_RECOUNT
;

	MR_SET_TURN180_OV
	
	INC	R_TURN180_CNT0
	LDA	R_TURN180_CNT0
	CMP	#6
	BCC	CHK_TURN180_1_EXIT
	STZ	R_TURN180_CNT0

	M_SET_KEYCH1_FLAG
	LDA	#0
	STA	WB_KEYCH_CODE+1
	
CHK_TURN180_1_RESET:
	MR_SET_TURN180_IDX 0,0
CHK_TURN180_1_RECOUNT:
	STZ	R_TURN180_CNT0
CHK_TURN180_1_EXIT:
	JMP	CHK_TURN180_EXIT
;
CHK_TURN180_2:
	M_int_Inside_plus R_XVAL,#(C_TURN180_X-C_TURN180_TOLERENCE),#(C_TURN180_X+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_2_RECOUNT
	M_int_Inside_plus R_YVAL,#(C_TURN180_Y-C_TURN180_TOLERENCE),#(C_TURN180_Y+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_2_RECOUNT
	M_int_Inside_plus R_ZVAL,#(C_TURN180_Z1-C_TURN180_TOLERENCE),#(C_TURN180_Z1+C_TURN180_TOLERENCE)
	BNE	CHK_TURN180_2_RECOUNT
;

	MR_SET_TURN180_OV
	
	INC	R_TURN180_CNT0
	LDA	R_TURN180_CNT0
	CMP	#6
	BCC	CHK_TURN180_2_EXIT
	STZ	R_TURN180_CNT0

	M_SET_KEYCH1_FLAG
	LDA	#1
	STA	WB_KEYCH_CODE+1
	
CHK_TURN180_2_RESET:
	MR_SET_TURN180_IDX 0,0
CHK_TURN180_2_RECOUNT:
	STZ	R_TURN180_CNT0
CHK_TURN180_2_EXIT:
	JMP	CHK_TURN180_EXIT


CHK_TURN180_EXIT:
	RTS
