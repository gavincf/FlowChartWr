
; 360'C,stick
;USED 3 step detect:
;0,start motion;start motion;>200ms
;1,moving detecting
;2,ending motion detecting



;@+/-4g;12bit,

C_FORWARDSTRIKE_HORT_START EQU 12+C_SHIFT_PLUS

C_FORWARDSTRIKE_VERT_START1 EQU 32+C_SHIFT_PLUS;x
C_FORWARDSTRIKE_VERT_START2 EQU -32+C_SHIFT_PLUS;x

C_FORWARDSTRIKE_Z EQU 0+C_SHIFT_PLUS

C_FORWARDSTRIKE_TOLERENCE EQU 15
C_FORWARDSTRIKE_START_TOLERENCE EQU 9

C_FORWARDSTRIKE_HORT_MOVE1_P EQU C_SHIFT_PLUS+15;USED

C_FORWARDSTRIKE_HORT_END_N EQU C_SHIFT_PLUS-0


;==================================
;check 
;===================================
;===================================
; ; @FXF15
;===================================
L_FORWARDSTRIKE_OV:
	LDA	R_FORWARDSTRIKE_OV_DLYCNT
	BEQ	L_FORWARDSTRIKE_OV_S20
	INC	R_FORWARDSTRIKE_OV_DLYCNT
	BNE	L_FORWARDSTRIKE_OV_S20
	
	STZ	R_FORWARDSTRIKE_CHK_STEP
	
	LDA	R_SWIPE_FLAG1
	CMP	#1
	BNE	L_FORWARDSTRIKE_OV_S20
	
	M_SET_KEYCH0_FLAG
	STZ	WB_KEYCH_CODE
	
L_FORWARDSTRIKE_OV_S20:
	RTS


;===================================
;WAITKEY_GAP2B_PCC
;===================================
CHK_FORWARDSTRIKE:
;
	LDA	R_1ST_AVR_CNT
	CMP	#16
	BCC	CHK_FORWARDSTRIKE_EXIT_J1

	LDA	R_FORWARDSTRIKE_STEP_DLYCNT
	BEQ	CHK_FORWARDSTRIKE_S010
	INC	R_FORWARDSTRIKE_STEP_DLYCNT
	BEQ	CHK_FORWARDSTRIKE_S010

;COUNTTING for next step	
CHK_FORWARDSTRIKE_EXIT_J1:
	
	JMP	CHK_FORWARDSTRIKE_EXIT
	
CHK_FORWARDSTRIKE_S010:
	LDX	R_Gsensor_SaveP
	BNE	CHK_FORWARDSTRIKE_S011
	LDX	#32
CHK_FORWARDSTRIKE_S011:
	DEX

	LDA	R_SaveX_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_HORIZONTAL_VAL_P
	LDA	R_SaveY_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_VERTICAL_VAL_P;;
	LDA	R_SaveZ_Base,X
	CLC
	ADC	#C_SHIFT_PLUS
	STA	R_ZVAL;;Z
;

	LDA	R_FORWARDSTRIKE_CHK_STEP
	ASL	A
	TAX
	JMP	(CHK_FORWARDSTRIKE_TBL,X)
CHK_FORWARDSTRIKE_TBL:
	DW	CHK_FORWARDSTRIKE_0;check action start
	DW	CHK_FORWARDSTRIKE_1;
	DW	CHK_FORWARDSTRIKE_2
	DW	CHK_FORWARDSTRIKE_EXIT;

CHK_FORWARDSTRIKE_0:;default = 0;;OTHER MODE;

	LDA	R_HORIZONTAL_VAL_P
	CMP	#C_FORWARDSTRIKE_HORT_START
	BCS	CHK_FORWARDSTRIKE_0_RELEASE
;hold
	
	INC	R_FORWARDSTRIKE_CNT
	BNE	CHK_FORWARDSTRIKE_0_EXIT
	DEC	R_FORWARDSTRIKE_CNT
CHK_FORWARDSTRIKE_0_EXIT:
	JMP	CHK_FORWARDSTRIKE_EXIT

CHK_FORWARDSTRIKE_0_RELEASE:;release

;	LDA	R_FORWARDSTRIKE_CNT
;	CMP	#1;5 ; *48MS
;	BCC	CHK_FORWARDSTRIKE_0_RELEASE_RESET

	STZ	R_FORWARDSTRIKE_CNT
;
;according to waveform of G-SENSOR data
	MR_SET_FORWARDSTRIKE_IDX 0,1;delay 150ms
	MR_SET_FORWARDSTRIKE_OV ;500ms
;

	JMP	CHK_FORWARDSTRIKE_EXIT

CHK_FORWARDSTRIKE_0_RELEASE_RESET:
	STZ	R_FORWARDSTRIKE_CNT ;restart
	JMP	CHK_FORWARDSTRIKE_EXIT

CHK_FORWARDSTRIKE_1:;moving

	LDA	R_HORIZONTAL_VAL_P;X
.IF (C_HORIZONTAL_DIR .EQ. C_PLUS )
	CMP	#C_FORWARDSTRIKE_HORT_MOVE1_N
	BCS	CHK_FORWARDSTRIKE_1_RECOUNT
.ELSE
	CMP	#C_FORWARDSTRIKE_HORT_MOVE1_P
	BCC	CHK_FORWARDSTRIKE_1_RECOUNT
.ENDIF
;start
	MR_SET_FORWARDSTRIKE_OV

	INC	R_FORWARDSTRIKE_CNT
	LDA	R_FORWARDSTRIKE_CNT
	CMP	#2
	BCC	CHK_FORWARDSTRIKE_1_EXIT
	STZ	R_FORWARDSTRIKE_CNT
;

;according to waveform of G-SENSOR data
	MR_SET_FORWARDSTRIKE_IDX 256-2,2;@GAP2=48MS ;delay
	
	JMP	CHK_FORWARDSTRIKE_EXIT
;CHK_FORWARDSTRIKE_1_RESET: ;RESET
	MR_SET_FORWARDSTRIKE_IDX 0,0;
	
CHK_FORWARDSTRIKE_1_TIMEOUT:
	MR_STOP_FORWARDSTRIKE_OV
CHK_FORWARDSTRIKE_1_RECOUNT: 
	STZ	R_FORWARDSTRIKE_CNT
	JMP	CHK_FORWARDSTRIKE_EXIT

CHK_FORWARDSTRIKE_1_EXIT:
	JMP	CHK_FORWARDSTRIKE_EXIT
	
CHK_FORWARDSTRIKE_2:

	LDA	R_HORIZONTAL_VAL_P;X
.IF (C_HORIZONTAL_DIR .EQ. C_PLUS )
	CMP	#C_FORWARDSTRIKE_HORT_END_P
;	BCC	CHK_FORWARDSTRIKE_2_TIMEOUT
	BCC	CHK_FORWARDSTRIKE_2_EXIT
.ELSE
	CMP	#C_FORWARDSTRIKE_HORT_END_N
;	BCS	CHK_FORWARDSTRIKE_2_TIMEOUT
	BCS	CHK_FORWARDSTRIKE_2_EXIT
.ENDIF
;TRIGGER
	MR_SET_FORWARDSTRIKE_OV
	
;get
	M_SET_KEYCH0_FLAG
	STZ	WB_KEYCH_CODE
	STZ	R_SWIPE_FLAG1

;according to waveform of G-SENSOR data
	MR_SET_FORWARDSTRIKE_IDX 0,0;
	MR_STOP_FORWARDSTRIKE_OV
	
	STZ	R_FORWARDSTRIKE_CNT
;
	JMP	CHK_FORWARDSTRIKE_EXIT
CHK_FORWARDSTRIKE_2_TIMEOUT:
	MR_SET_FORWARDSTRIKE_OV

CHK_FORWARDSTRIKE_2_RECOUNT:
	STZ	R_FORWARDSTRIKE_CNT

CHK_FORWARDSTRIKE_2_EXIT:
	JMP	CHK_FORWARDSTRIKE_EXIT

CHK_FORWARDSTRIKE_EXIT:
	RTS
